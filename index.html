<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jadwal Ketersediaan Ruangan FT UPNVJ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .room-available {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      transition: all 0.3s ease;
    }
    .room-available:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 25px rgba(16, 185, 129, 0.12);
    }
    .room-occupied {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      transition: all 0.3s ease;
    }
    .room-occupied:hover {
      transform: scale(1.03);
      box-shadow: 0 8px 25px rgba(239, 68, 68, 0.12);
    }
    #logoutBtn {
    display: inline-block;
    }
      /* Tambahan background adaptif */
    #loginAwal {
    background: url('bglogin.png') no-repeat center center fixed;
    background-size: cover;
   }

   #mainContent {
    background: url('GedungFT.jpg') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
   }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ===========================
       LOGIN AWAL (PILIH ROLE)
       =========================== -->
  <div id="loginAwal" class="fixed inset-0 bg-gray-100 flex items-center justify-center z-40">
    <div class="bg-white p-8 rounded-xl shadow-lg w-[420px]">
      <h1 class="text-2xl font-bold text-center mb-4">Masuk</h1>
      <input id="loginUsername" type="text" placeholder="Username" class="w-full border border-gray-300 rounded-lg p-3 mb-3" />
      <input id="loginPassword" type="password" placeholder="Password" class="w-full border border-gray-300 rounded-lg p-3 mb-3" />
      <select id="loginRole" class="w-full border border-gray-300 rounded-lg p-3 mb-4">
        <option value="user">User</option>
        <option value="admin">Admin</option>
      </select>
      <div class="flex gap-3">
        <button onclick="prosesLogin()" class="flex-1 bg-blue-800 text-white py-2 rounded-lg hover:bg-blue-900">Masuk</button>
      </div>
      <p class="text-xs text-gray-500 mt-3">Catatan: untuk user, masukkan username apa saja; untuk admin gunakan username: <b>admin</b> password: <b>admin</b>.</p>
    </div>
  </div>

  <!-- ===========================
       KONTEN UTAMA (STRUKTUR LAMA)
       =========================== -->
  <div id="mainContent" class="hidden">
    <!-- Header -->
    <header class="bg-yellow-400 text-black py-4 shadow-md flex flex-col sm:flex-row items-center justify-center relative text-center sm:text-left px-4">
      <img src="LOGO UPNVJ.png" alt="Logo UPNVJ" class="sm:absolute sm:left-6 w-14 h-14 sm:w-16 sm:h-16 mb-2 sm:mb-0" />
      <h1 class="text-xl sm:text-2xl md:text-3xl font-bold px-4">Jadwal Ketersediaan Ruangan FT UPNVJ</h1>
      <div id="userInfo" class="sm:absolute sm:right-6 top-4 text-sm text-gray-800 hidden text-right">
        <div id="userInfoText"></div>
        <button onclick="logout()" id="logoutBtn" class="mt-1 bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-md text-xs transition">Logout</button>
</div>

    </header>

    <!-- Navigation -->
    <nav class="bg-gray-800 text-white py-3 flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-12 text-center px-4">
      <button id="navJadwal" onclick="showTab('jadwal')" class="hover:underline px-3 py-1">Menu Utama</button>
      <button id="navBooking" onclick="showTab('booking')" class="hover:underline px-3 py-1">Booking Ruangan</button>
      <button id="navAdmin" onclick="showTab('admin')" class="hover:underline px-3 py-1 hidden">Pengajuan Permohonan</button>
      <button id="navEditStatus" onclick="showTab('editStatus')" class="hover:underline px-3 py-1 hidden">Edit Status Ruangan</button>
    </nav>

    <!-- Menu Utama -->
    <div id="jadwal" class="p-4 sm:p-6">
      <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold inline-block pb-1">
            Menu Utama
          </h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="tanggal" class="block text-gray-700 mb-2 font-medium">Pilih Tanggal:</label>
            <input type="date" id="tanggal" class="w-full border border-gray-300 rounded-lg p-2" />
          </div>
          <div>
            <label for="jam" class="block text-gray-700 mb-2 font-medium">Pilih Waktu:</label>
            <select id="jam" class="w-full border border-gray-300 rounded-lg p-2"></select>
          </div>
        </div>

        <div class="flex justify-center mb-6">
          <button onclick="renderRuangan()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
            Lihat Ruangan
          </button>
        </div>

        <div id="RuanganContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
      </div>
    </div>

    <!-- Booking Ruangan (Hanya untuk User) -->
    <div id="booking" class="hidden p-4 sm:p-6">
      <div class="max-w-lg mx-auto bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-center mb-4">Permohonan Booking Ruangan</h2>
        <form id="bookingForm" class="space-y-4" onsubmit="event.preventDefault(); submitBooking();">
          <div>
            <input id="nama" name="nama" type="text" placeholder="Nama Lengkap" class="w-full border border-gray-300 rounded-lg p-3" />
            <p id="errorNama" class="text-red-500 text-sm mt-1 hidden">Nama hanya boleh berisi huruf dan spasi.</p>
          </div>
          <div>
            <input id="nim" name="nim" type="text" placeholder="NIM / NIDN" class="w-full border border-gray-300 rounded-lg p-3" />
            <p id="errorNim" class="text-red-500 text-sm mt-1 hidden">NIM hanya boleh berisi angka.</p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <input id="tanggalBooking" name="tanggalBooking" type="date" class="w-full border border-gray-300 rounded-lg p-3" />
            <select id="bookingWaktu" name="bookingWaktu" class="w-full border border-gray-300 rounded-lg p-3"></select>
          </div>

          <select id="ruang" name="ruang" class="w-full border border-gray-300 rounded-lg p-3">
            <option value="">Pilih Ruang</option>
          </select>

          <textarea id="keteranganBooking" name="keteranganBooking" placeholder="Keterangan (contoh: Ruangan pengganti, rapat, dsb)" class="w-full border border-gray-300 rounded-lg p-3" rows="3"></textarea>

          <button type="submit" class="w-full bg-blue-600 text-white rounded-lg py-3 font-semibold hover:bg-blue-700 transition">Ajukan Permohonan</button>
        </form>

        <div id="userInbox" class="mt-4">
          <h3 class="font-semibold">Inbox</h3>
          <div id="inboxList" class="text-sm text-gray-700 mt-2"></div>
        </div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin" class="hidden p-4 sm:p-6">
      <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-center mb-4">Pengajuan Permohonan</h2>

        <div class="mb-4 flex gap-3">
          <button onclick="renderAdminRequests()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Daftar Permohonan</button>
          <button onclick="renderScheduleOverview()" class="bg-green-600 text-white px-4 py-2 rounded-lg">Overview Jadwal</button>
          <button onclick="resetJadwal()" class="ml-auto bg-red-600 text-white px-4 py-2 rounded-lg">Reset Jadwal</button>
        </div>

        <div id="adminContent"></div>
      </div>
    </div>

    <!-- Edit Status Ruangan (Hanya untuk Admin) -->
    <div id="editStatus" class="hidden p-4 sm:p-6">
      <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-2xl font-bold text-center mb-4">Edit Status Ruangan</h2>

        <form id="editStatusForm" onsubmit="event.preventDefault(); ubahStatusRuangan();" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 mb-2 font-medium">Tanggal</label>
              <input id="editTanggal" type="date" class="w-full border border-gray-300 rounded-lg p-2" required>
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium">Jam Ruangan</label>
              <select id="editJam" class="w-full border border-gray-300 rounded-lg p-2" required></select>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 mb-2 font-medium">Nomor Ruangan</label>
              <select id="editRuang" class="w-full border border-gray-300 rounded-lg p-2" required></select>
            </div>
            <div>
              <label class="block text-gray-700 mb-2 font-medium">Opsi Status</label>
              <select id="editOpsi" class="w-full border border-gray-300 rounded-lg p-2" required>
                <option value="kosong">Kosongkan</option>
                <option value="terpakai">Terpakai</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-gray-700 mb-2 font-medium">Nama Lengkap</label>
            <input id="editNama" type="text" placeholder="Nama Lengkap" class="w-full border border-gray-300 rounded-lg p-2">
          </div>

          <div>
            <label class="block text-gray-700 mb-2 font-medium">NIM / NIDN</label>
            <input id="editNim" type="text" placeholder="NIM / NIDN" class="w-full border border-gray-300 rounded-lg p-2">
          </div>

          <div>
            <label class="block text-gray-700 mb-2 font-medium">Keterangan</label>
            <textarea id="editKet" placeholder="Keterangan tambahan" class="w-full border border-gray-300 rounded-lg p-2" rows="3"></textarea>
          </div>

          <div class="flex justify-center">
            <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition">Ubah Status</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ===========================
       SCRIPT: LOGIKA APLIKASI
       =========================== -->
  <script>
    /* -------------------------
       Data model (localStorage)
       - bookingList: semua permohonan booking (status: Menunggu / Disetujui / Ditolak)
       - RuanganStatus: object tanggal -> waktu -> ruang -> {status:'terpakai'|'kosong', by: nama, nim}
       - usersNotifications: object keyed by username -> array of notifications {id, bookingId, status, message, createdAt}
       ------------------------- */
    const RuanganList = ["301","302","303","304","305","306","401","402","403","404","405","406","ATA"];
    const waktuList = [
      "07.10-08.50", "08.50-10.30", "09.40-11.20",
      "10.30-12.10", "13.00-14.40", "14.40-16.20", "15.40-17.20"
    ];

    let bookingList = JSON.parse(localStorage.getItem("bookingList")) || [];
    let RuanganStatus = JSON.parse(localStorage.getItem("RuanganStatus")) || {}; // {tanggal: {waktu: {ruang: {status, by, nim}}}}
    let usersNotifications = JSON.parse(localStorage.getItem("usersNotifications")) || {}; // { username: [notif...]}

    let currentRole = null;
    let currentUser = null;

    // -------------------------
    // Helper: simpan data
    function saveAll() {
      localStorage.setItem("bookingList", JSON.stringify(bookingList));
      localStorage.setItem("RuanganStatus", JSON.stringify(RuanganStatus));
      localStorage.setItem("usersNotifications", JSON.stringify(usersNotifications));
    }

    // -------------------------
    // Inisialisasi tampilan (waktu, pilihan ruang)
    function initSelectors() {
      const jam = document.getElementById('jam');
      const bookingWaktu = document.getElementById('bookingWaktu');
      if (jam) jam.innerHTML = waktuList.map(w => `<option value="${w}">${w}</option>`).join('');
      if (bookingWaktu) bookingWaktu.innerHTML = waktuList.map(w => `<option value="${w}">${w}</option>`).join('');
      const ruangSel = document.getElementById('ruang');
      if (ruangSel) {
        ruangSel.innerHTML = `<option value="">Pilih Ruang</option>` + RuanganList.map(r => `<option value="${r}">${r}</option>`).join('');
      }
    }

    // -------------------------
    // LOGIN
    function prosesLogin() {
      const user = document.getElementById('loginUsername').value.trim();
      const pass = document.getElementById('loginPassword').value.trim();
      const role = document.getElementById('loginRole').value;

      if (!user || !role) {
        alert('Isi username dan pilih peran');
        return;
      }

      // simple admin check
      if (role === 'admin') {
        if (user !== 'admin' || pass !== 'admin') {
          alert('Login admin salah. Gunakan username: admin dan password: admin');
          return;
        }
      }

      // Set current user & role
      currentRole = role;
      currentUser = user;
      document.getElementById('loginAwal').classList.add('hidden');
      document.getElementById('mainContent').classList.remove('hidden');
      document.getElementById('userInfo').classList.remove('hidden');
      document.getElementById('userInfoText').innerText = `Masuk sebagai: ${currentUser} (${currentRole})`;

      // hide/show nav accordingly
      if (currentRole === 'admin') {
        document.getElementById('navAdmin').classList.remove('hidden');
        document.getElementById('navEditStatus').classList.remove('hidden');
        document.getElementById('navBooking').classList.add('hidden'); // admin tidak punya booking tab
        showTab('admin'); // default ke admin
        renderAdminRequests();
      } else {
        document.getElementById('navAdmin').classList.add('hidden');
        document.getElementById('navBooking').classList.remove('hidden');
        showTab('jadwal');
      }

      initSelectors();
      renderRuangan();
      renderInboxForCurrentUser();
    }

    // Demo quick-fill (optional)
    function demoIsi() {
      document.getElementById('loginUsername').value = 'demoUser';
      document.getElementById('loginPassword').value = '';
      document.getElementById('loginRole').value = 'user';
    }

    // -------------------------
    // RENDER Ruangan (Menu Utama)
    function renderRuangan() {
      const tanggal = document.getElementById('tanggal').value || 'default';
      const waktu = document.getElementById('jam').value || 'default';
      const container = document.getElementById('RuanganContainer');
      container.innerHTML = '';

      // prepare object shapes
      if (!RuanganStatus[tanggal]) RuanganStatus[tanggal] = {};
      if (!RuanganStatus[tanggal][waktu]) RuanganStatus[tanggal][waktu] = {};

      RuanganList.forEach(Ruangan => {
        const data = RuanganStatus[tanggal][waktu][Ruangan] || { status: 'kosong' };
        const div = document.createElement('div');
        div.className = `${data.status === 'kosong' ? 'room-available' : 'room-occupied'} p-4 rounded-xl text-center cursor-pointer`;
        let inner = `<div class="text-lg sm:text-2xl font-bold mb-1">${Ruangan}</div>`;
        inner += `<div class="text-xs sm:text-sm">${data.status === 'kosong' ? 'Tersedia' : 'Terpakai'}</div>`;
        if (data.status === 'terpakai' && currentRole === 'admin') {
          inner += `<div class="text-[10px] mt-2 italic">Oleh: ${data.by || '-'} ${data.nim ? `(${data.nim})` : ''}</div>`;
        }
        div.innerHTML = inner;
        container.appendChild(div);
      });

      // save RuanganStatus in case we created empty objects
      saveAll();
    }

    // -------------------------
    // USER: submit booking
    function submitBooking() {
      // validation
      const nama = document.getElementById('nama').value.trim();
      const nim = document.getElementById('nim').value.trim();
      const tanggalBooking = document.getElementById('tanggalBooking').value;
      const waktuBooking = document.getElementById('bookingWaktu').value;
      const ruang = document.getElementById('ruang').value;
      const ket = document.getElementById('keteranganBooking').value.trim();

      const errNama = document.getElementById('errorNama');
      const errNim = document.getElementById('errorNim');
      let ok = true;
      if (!/^[A-Za-z\s]+$/.test(nama) || !nama) { errNama.classList.remove('hidden'); ok = false; } else errNama.classList.add('hidden');
      if (!/^[0-9]+$/.test(nim) || !nim) { errNim.classList.remove('hidden'); ok = false; } else errNim.classList.add('hidden');
      if (!tanggalBooking || !waktuBooking || !ruang) { alert('Lengkapi tanggal, jam, dan ruang'); ok = false; }

      if (!ok) return;

      // create booking object
      const newBooking = {
        id: Date.now(),
        nama, nim, tanggal: tanggalBooking, waktu: waktuBooking, ruang, ket,
        status: 'Menunggu',
        user: currentUser || nama // identify user by login username if any
      };
      bookingList.push(newBooking);
      saveAll();

      // feedback
      alert('Permohonan booking terkirim. Menunggu persetujuan admin.');
      // clear form
      document.getElementById('bookingForm').reset();
      renderRuangan();
      // if admin viewing, refresh their list
      if (currentRole === 'admin') renderAdminRequests();
    }

    // -------------------------
    // ADMIN: render permohonan list
    function renderAdminRequests() {
      const box = document.getElementById('adminContent');
      box.innerHTML = '';
      if (bookingList.length === 0) {
        box.innerHTML = '<p class="text-gray-600">Belum ada permohonan booking.</p>';
        return;
      }

      // build list of requests (show newest first)
      const list = bookingList.slice().reverse();
      list.forEach(req => {
        // show each request
        const div = document.createElement('div');
        div.className = 'border rounded-lg p-4 mb-3 bg-white';
        div.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <div class="font-semibold text-lg">${req.nama} <span class="text-sm text-gray-500">(${req.nim})</span></div>
              <div class="text-sm text-gray-600">Ruang: <b>${req.ruang}</b> — ${req.tanggal} | ${req.waktu}</div>
              <div class="text-sm text-gray-600">Keterangan: ${req.ket || '-'}</div>
              <div class="text-sm mt-2">Status: <span class="font-semibold ${req.status === 'Disetujui' ? 'text-green-600' : req.status === 'Ditolak' ? 'text-red-600' : 'text-yellow-600'}">${req.status}</span></div>
            </div>

            <div class="text-right">
              ${req.status === 'Menunggu' ? `
                <button onclick="adminAccept(${req.id})" class="bg-green-500 text-white px-3 py-1 rounded-lg mb-2 block">ACC</button>
                <button onclick="adminShowRejectBox(${req.id})" class="bg-red-500 text-white px-3 py-1 rounded-lg block">Tolak</button>
              ` : ''}
            </div>
          </div>
          <div id="rejectBox-${req.id}" class="mt-3 hidden">
            <textarea id="rejectReason-${req.id}" placeholder="Alasan penolakan (opsional)" class="w-full border rounded-lg p-2 mb-2"></textarea>
            <div class="flex justify-end gap-2">
              <button onclick="adminReject(${req.id})" class="bg-red-600 text-white px-3 py-1 rounded-lg">Kirim Tolak</button>
              <button onclick="adminHideRejectBox(${req.id})" class="bg-gray-200 px-3 py-1 rounded-lg">Batal</button>
            </div>
          </div>
        `;
        box.appendChild(div);
      });
    }

    function adminShowRejectBox(id) {
      const el = document.getElementById(`rejectBox-${id}`);
      if (el) el.classList.remove('hidden');
    }
    function adminHideRejectBox(id) {
      const el = document.getElementById(`rejectBox-${id}`);
      if (el) el.classList.add('hidden');
    }

    // admin accepts booking: set RuanganStatus[tanggal][waktu][ruang] = terpakai with by & nim
    function adminAccept(id) {
      const idx = bookingList.findIndex(b => b.id === id);
      if (idx === -1) { alert('Data tidak ditemukan'); return; }
      const req = bookingList[idx];

      // initialize structures
      if (!RuanganStatus[req.tanggal]) RuanganStatus[req.tanggal] = {};
      if (!RuanganStatus[req.tanggal][req.waktu]) RuanganStatus[req.tanggal][req.waktu] = {};
      // set status for that room
      RuanganStatus[req.tanggal][req.waktu][req.ruang] = {
        status: 'terpakai',
        by: req.nama,
        nim: req.nim
      };

      // update booking status and create notification for user
      req.status = 'Disetujui';
      const notif = {
        id: Date.now(),
        bookingId: req.id,
        status: 'Disetujui',
        message: `Booking Anda untuk ruang ${req.ruang} pada ${req.tanggal} ${req.waktu} telah DISETUJUI.`,
        createdAt: new Date().toISOString()
      };
      if (!usersNotifications[req.user]) usersNotifications[req.user] = [];
      usersNotifications[req.user].push(notif);

      saveAll();
      renderAdminRequests();
      renderRuangan();
      // if current view is user (same browser), refresh inbox display
      renderInboxForCurrentUser();

      alert(`Booking ID ${req.id} disetujui — ruang ${req.ruang} ditandai TERPAKAI pada tanggal ${req.tanggal} jam ${req.waktu}.`);
    }

    // admin rejects booking: set booking.status, add notification with reason
    function adminReject(id) {
      const idx = bookingList.findIndex(b => b.id === id);
      if (idx === -1) { alert('Data tidak ditemukan'); return; }
      const req = bookingList[idx];
      const reasonInput = document.getElementById(`rejectReason-${id}`);
      const reason = reasonInput ? reasonInput.value.trim() : '';

      req.status = 'Ditolak';
      req.rejectReason = reason;

      const notif = {
        id: Date.now(),
        bookingId: req.id,
        status: 'Ditolak',
        message: `Booking Anda untuk ruang ${req.ruang} pada ${req.tanggal} ${req.waktu} DITOLAK. ${reason ? 'Alasan: ' + reason : ''}`,
        createdAt: new Date().toISOString()
      };
      if (!usersNotifications[req.user]) usersNotifications[req.user] = [];
      usersNotifications[req.user].push(notif);

      saveAll();
      renderAdminRequests();
      renderInboxForCurrentUser();

      alert(`Permohonan ID ${req.id} telah ditolak.`);
    }

    // -------------------------
    // ADMIN: overview jadwal (lihat seluruh RuanganStatus)
// -------------------------
// ADMIN: overview jadwal (lihat seluruh RuanganStatus)
    function renderScheduleOverview() {
      const box = document.getElementById('adminContent');
      box.innerHTML = '<h3 class="font-semibold mb-3">Overview Jadwal (terpakai)</h3>';
      const keys = Object.keys(RuanganStatus);
      if (keys.length === 0) {
        box.innerHTML += '<p class="text-gray-600">Belum ada jadwal terpakai.</p>';
        return;
      }
      const wrapper = document.createElement('div');
      wrapper.className = 'space-y-3';
      keys.forEach(tanggal => {
        const times = RuanganStatus[tanggal];
        Object.keys(times).forEach(waktu => {
          const rooms = times[waktu];
          const usedRooms = Object.keys(rooms).filter(r => rooms[r].status === 'terpakai');
          if (usedRooms.length === 0) return;

          const card = document.createElement('div');
          card.className = 'p-3 border rounded-lg bg-gray-50';
          let html = `<div class="font-semibold mb-2">${tanggal} — ${waktu}</div>`;
          html += usedRooms.map(r => {
            const info = rooms[r];
            return `
              <div class="text-sm mb-1">
                <b>Ruang ${r}</b> — oleh ${info.by || '-'} (${info.nim || '-'})
                ${info.ket ? `<div class="text-xs text-gray-600 ml-4">Keterangan: ${info.ket}</div>` : ''}
              </div>
            `;
          }).join('');
          card.innerHTML = html;
          wrapper.appendChild(card);
        });
      });
      box.appendChild(wrapper);
    }

    // -------------------------
    // RESET JADWAL (ADMIN)
    function resetJadwal() {
      if (!confirm('Yakin ingin mereset semua jadwal (status terpakai akan dikosongkan)?')) return;
      RuanganStatus = {};
      // Do NOT clear bookingList by request — we only reset jadwal
      saveAll();
      renderScheduleOverview();
      renderRuangan();
      alert('Semua jadwal (status ruangan) telah direset.');
    }

    // -------------------------
    // INBOX / NOTIF (User)
    function renderInboxForCurrentUser() {
      // show notifications for currentUser if role is user
      if (!currentUser) return;
      const inboxDiv = document.getElementById('inboxList');
      if (!inboxDiv) return;
      const notes = usersNotifications[currentUser] || [];
      if (notes.length === 0) {
        inboxDiv.innerHTML = '<p class="text-gray-500">Belum ada notifikasi.</p>';
        return;
      }
      // newest first
      const list = notes.slice().reverse();
      inboxDiv.innerHTML = list.map(n => `
        <div class="p-2 border-b">
          <div class="text-sm">${n.message}</div>
          <div class="text-xs text-gray-400 mt-1">${new Date(n.createdAt).toLocaleString()}</div>
        </div>
      `).join('');
    }

    // -------------------------
    // NAVIGATION
    function showTab(tabId) {
      ['jadwal','booking','admin','editStatus'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.add('hidden');
      });
      const target = document.getElementById(tabId);
      if (target) target.classList.remove('hidden');

      if (tabId === 'jadwal') renderRuangan();
      if (tabId === 'booking') renderInboxForCurrentUser();
      if (tabId === 'admin') renderAdminRequests();
    }

    // -------------------------
    // Logout (langsung keluar tanpa konfirmasi)
    function logout() {
      currentRole = null;
      currentUser = null;

      // Sembunyikan konten utama dan tampilkan login
      document.getElementById('mainContent').classList.add('hidden');
      document.getElementById('loginAwal').classList.remove('hidden');

      // Sembunyikan info user dan reset teks
      const infoDiv = document.getElementById('userInfo');
      if (infoDiv) {
        infoDiv.classList.add('hidden');
        const userText = document.getElementById('userInfoText');
        if (userText) userText.textContent = '';
      }
    }

    // -------------------------
    // ADMIN: Edit Status Ruangan → sinkron ke bookingList
    function ubahStatusRuangan() {
      const tanggal = document.getElementById('editTanggal').value;
      const jam = document.getElementById('editJam').value;
      const ruang = document.getElementById('editRuang').value;
      const opsi = document.getElementById('editOpsi').value;
      const nama = document.getElementById('editNama').value.trim();
      const nim = document.getElementById('editNim').value.trim();
      const ket = document.getElementById('editKet').value.trim();

      if (!tanggal || !jam || !ruang || !opsi) {
        alert('Lengkapi semua data wajib.');
        return;
      }

      // Inisialisasi struktur data
      if (!RuanganStatus[tanggal]) RuanganStatus[tanggal] = {};
      if (!RuanganStatus[tanggal][jam]) RuanganStatus[tanggal][jam] = {};

      // Ubah status ruang
      if (opsi === 'terpakai') {
        RuanganStatus[tanggal][jam][ruang] = { status: 'terpakai', by: nama, nim: nim, ket: ket };
      } else {
        RuanganStatus[tanggal][jam][ruang] = { status: 'kosong' };
      }

      // Sinkronkan dengan bookingList
      let found = false;
      bookingList.forEach(b => {
        if (b.tanggal === tanggal && b.waktu === jam && b.ruang === ruang) {
          b.status = (opsi === 'terpakai') ? 'Disetujui' : 'Ditolak';
          found = true;

          // Tambahkan notifikasi untuk user
          const notif = {
            id: Date.now(),
            bookingId: b.id,
            status: b.status,
            message: `Permohonan Anda untuk ruang ${ruang} pada ${tanggal} ${jam} telah ${b.status.toUpperCase()}.`,
            createdAt: new Date().toISOString()
          };
          if (!usersNotifications[b.user]) usersNotifications[b.user] = [];
          usersNotifications[b.user].push(notif);
        }
      });

      saveAll();
      renderRuangan();
      renderAdminRequests();
      alert(`Status ruang ${ruang} pada ${tanggal} jam ${jam} telah diubah menjadi ${opsi.toUpperCase()}${found ? ' dan data permohonan diperbarui.' : '.'}`);

      document.getElementById('editStatusForm').reset();
    }

    // Initialize page (populate default waktu)
    initSelectors();
    // Default: hide main content (login shown)
    document.getElementById('mainContent').classList.add('hidden');

    // If you want: automatically render Ruangan for "today" by default
    const todayInput = document.getElementById('tanggal');
    if (todayInput) {
      const today = new Date().toISOString().slice(0,10);
      todayInput.value = today;
    }

    // -------------------------
    // ADMIN: Edit Status Ruangan
    function ubahStatusRuangan() {
      const tanggal = document.getElementById('editTanggal').value;
      const waktu = document.getElementById('editJam').value;
      const ruang = document.getElementById('editRuang').value;
      const opsi = document.getElementById('editOpsi').value;
      const nama = document.getElementById('editNama').value.trim();
      const nim = document.getElementById('editNim').value.trim();
      const ket = document.getElementById('editKet').value.trim();

      if (!tanggal || !waktu || !ruang) {
        alert('Harap lengkapi tanggal, jam, dan ruang.');
        return;
      }

      if (!RuanganStatus[tanggal]) RuanganStatus[tanggal] = {};
      if (!RuanganStatus[tanggal][waktu]) RuanganStatus[tanggal][waktu] = {};

      if (opsi === 'kosong') {
        delete RuanganStatus[tanggal][waktu][ruang];
        alert(`Ruang ${ruang} pada ${tanggal} jam ${waktu} telah dikosongkan.`);
      } else {
        RuanganStatus[tanggal][waktu][ruang] = {
          status: 'terpakai',
          by: nama || '-',
          nim: nim || '-',
          ket: ket || ''
        };
        alert(`Ruang ${ruang} pada ${tanggal} jam ${waktu} ditandai sebagai TERPAKAI.`);
      }

      saveAll();
      renderRuangan();
      document.getElementById('editStatusForm').reset();
    }

    // Pastikan dropdown jam & ruang ikut terisi saat halaman admin dibuka
    const editJam = document.getElementById('editJam');
    const editRuang = document.getElementById('editRuang');
    if (editJam) editJam.innerHTML = waktuList.map(w => `<option value="${w}">${w}</option>`).join('');
    if (editRuang) editRuang.innerHTML = RuanganList.map(r => `<option value="${r}">${r}</option>`).join('');

  </script>
</body>
</html>
